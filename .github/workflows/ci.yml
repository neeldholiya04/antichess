name: Java CI

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  ci_pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      id-token: write

    env:
      IMAGE_NAME: antichess
      REGISTRY: docker.io
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

    steps:
    # ----------------------------------------------------
    # 1. Checkout
    # ----------------------------------------------------
    - name: Checkout source code
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2. Setup Java
    # ----------------------------------------------------
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven

    # ----------------------------------------------------
    # 3. Linting
    # ----------------------------------------------------
    - name: Run Maven Checkstyle
      run: mvn checkstyle:check
      continue-on-error: true

    # ----------------------------------------------------
    # 4. SAST – CodeQL INIT
    # ----------------------------------------------------
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: java

    # ----------------------------------------------------
    # 5. Build JAR
    # ----------------------------------------------------
    - name: Build with Maven
      run: mvn clean package -DskipTests -B

    # ----------------------------------------------------
    # 6. CodeQL Analysis
    # ----------------------------------------------------
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4

    # ----------------------------------------------------
    # 7. Cache OWASP Dependency-Check
    # ----------------------------------------------------
    - name: Cache OWASP Dependency-Check data
      uses: actions/cache@v4
      with:
        path: ~/.dependency-check
        key: dependency-check-${{ runner.os }}
        restore-keys: dependency-check-${{ runner.os }}

    # ----------------------------------------------------
    # 8. SCA – OWASP Dependency Check
    # ----------------------------------------------------
    - name: OWASP Dependency Check
      run: mvn org.owasp:dependency-check-maven:check
      continue-on-error: true

    # ----------------------------------------------------
    # 9. Extract Version
    # ----------------------------------------------------
    - name: Extract version
      id: version
      run: |
        if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="0.0.0-${GITHUB_SHA::7}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    # ----------------------------------------------------
    # 10. Set Maven Version
    # ----------------------------------------------------
    - name: Set Maven version
      run: mvn versions:set -DnewVersion=${{ steps.version.outputs.version }}

    # ----------------------------------------------------
    # 11. Docker Login
    # ----------------------------------------------------
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # ----------------------------------------------------
    # 12. Build Docker Image
    # ----------------------------------------------------
    - name: Build Docker image
      run: |
        docker build \
          -t $REGISTRY/${DOCKERHUB_USERNAME}/${IMAGE_NAME}:${{ steps.version.outputs.version }} \
          -t $REGISTRY/${DOCKERHUB_USERNAME}/${IMAGE_NAME}:latest \
          .

    # ----------------------------------------------------
    # 13. Test Docker Image
    # ----------------------------------------------------
    - name: Test Docker image runs
      run: |
        docker run --rm \
          $REGISTRY/${DOCKERHUB_USERNAME}/${IMAGE_NAME}:${{ steps.version.outputs.version }} \
          --help || true

    # ----------------------------------------------------
    # 14. Scan Image with Trivy
    # ----------------------------------------------------
    - name: Trivy image scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
        severity: CRITICAL,HIGH
        exit-code: 1
        format: table

    # ----------------------------------------------------
    # 15. Push Docker Image
    # ----------------------------------------------------
    - name: Push Docker image
      run: |
        docker push $REGISTRY/${DOCKERHUB_USERNAME}/${IMAGE_NAME}:${{ steps.version.outputs.version }}
        docker push $REGISTRY/${DOCKERHUB_USERNAME}/${IMAGE_NAME}:latest

    # ----------------------------------------------------
    # 16. Sign Image
    # ----------------------------------------------------
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3

    - name: Sign Docker image
      run: |
        cosign sign \
          $REGISTRY/${DOCKERHUB_USERNAME}/${IMAGE_NAME}:${{ steps.version.outputs.version }}
